EndlessSummer={value:0,avg:[],chart_data:[],labels:[],idx:0,LOG:true,min:99999,max:0,opts:null,ctx2:null,ctx3:null,lastin:0,THRESHOLD:0.20,chart:null,wavemax:0,accum:0,vel:0,drag:-0.99,mass:100,SCALER:100,DELTA_SCALE:3,FILTER_WIDTH:9,$w:$(window),$body:$('body'),opts:{scaleShowLabels:false,pointDotRadius:1,animation:false,scaleOverride:true,scaleSteps:60,scaleStepWidth:1,scaleStartValue:0,showTooltips:false,scaleShowLabels:false,showScale:false},init:function(id,url){this.video=typeof id=="undefined"?'zmPzbZVUp3g':id;this.URL=url;$('body').append("<style type='text/css'>"+"canvas {position:fixed;left:0;top:0;background:rgba(50,50,50,0.75);padding:25px;}"+"#debug {position:fixed;top:0;left:0;padding:20px;background-color:rgba(25,25,25,0.75);color:#FFF;}"+"</style>"+"<canvas id='myChart' width='400' height='200'></canvas>"+"<canvas id='info' width='400' height='200'></canvas>"+"<div id='debug'>30.00</div>");this.DEBUG=$('#debug');this.load();},filter:function(i){return(i[0]+i[1]*9+i[2]*17+i[3]*25+i[4]*33+i[5]*25+i[6]*17+i[7]*9+i[8])/81;},load:function(){_req(this.URL+'get/',{video:this.video},this.run);},_debug:function(_ctx){_ctx.clearRect(0,0,400,200);var r=200/60;_ctx.beginPath();_ctx.strokeStyle='red';_ctx.moveTo(0,200-(this.min*this.SCALER)*r);_ctx.lineTo(400,200-(this.min*this.SCALER)*r);_ctx.stroke();_ctx.closePath();_ctx.beginPath();_ctx.strokeStyle='orange';_ctx.moveTo(0,200-(this.cmin*this.SCALER)*r);_ctx.lineTo(400,200-(this.cmin*this.SCALER)*r);_ctx.stroke();_ctx.closePath();_ctx.beginPath();_ctx.strokeStyle='green';_ctx.moveTo(0,200-(this.max*this.SCALER)*r);_ctx.lineTo(400,200-(this.max*this.SCALER)*r);_ctx.stroke();_ctx.closePath();},run:function(data){if(data.status=='success'){var ctx=new webkitAudioContext();var url=data.file;var ctx2=document.getElementById("myChart").getContext("2d");var ctx3=document.getElementById("info").getContext("2d");this.audio=new Audio(url);this.processor=ctx.createScriptProcessor(2048,1,1);this.audio.addEventListener('canplaythrough',_.bind(function(){this.source=ctx.createMediaElementSource(this.audio)
this.source.connect(this.processor)
this.source.connect(ctx.destination)
this.processor.connect(ctx.destination)
this.audio.play()},this),false);this.processor.onaudioprocess=_.bind(function(evt){var input=evt.inputBuffer.getChannelData(0),len=input.length,total=i=0,rms,value;while(i<len)total+=Math.abs(input[i++]);rms=Math.sqrt(total/len);if(this.avg.length>=this.FILTER_WIDTH){this.avg.shift();this.avg.push(rms);value=this.filter(this.avg);this.max=Math.max(this.max,value);this.min=Math.min(this.min,value);if(this.min===99999)this.min=value;this.cmin=this.max*this.THRESHOLD+this.min;this._debug(ctx3);var chart_sample=100;var skip=0;var inter=1;var color;if(this.LOG){var input=value*this.SCALER;if(value>this.cmin&&input>this.lastin){color='green';this.accum+=(input-this.lastin)*this.DELTA_SCALE;}else{color='red';}
this.lastin=input;this.chart_data.push(input>=1?input:0);this.labels.push(this.idx++);if(this.idx>chart_sample){this.chart_data=this.chart_data.slice(1);this.labels=this.labels.slice(1);}
var d={labels:this.labels,datasets:[{label:"",fillColor:"rgba(220,220,220,0.85)",strokeColor:"rgba(220,220,220,1)",pointColor:"rgba(220,220,220,1)",pointStrokeColor:color,pointHighlightFill:color,pointHighlightStroke:"rgba(220,220,220,1)",data:this.chart_data}]}
if(this.chart===null){this.chart=new Chart(ctx2);this.chart.Line(d,this.opts);}else{this.chart.Line(d,this.opts);}}}else{this.avg.push(rms);}},this);}else{console.log('request failed..');}},kill:function(){$('#myChart').remove();$('#info').remove();$('#endless-summer-container').remove();this.audio.pause();this.processor.onaudioprocess=null;window.cancelAnimationFrame(this.animate);},animate:function(){window.requestAnimationFrame(this.animate);window.scrollBy(0,this.accum+0.5<<0);this.vel=(this.drag*this.accum)/this.mass;this.accum+=this.vel;this.DEBUG.html('m: '+this.mass+' / d: '+this.drag+' a: '+this.accum.toFixed(3));this.wavemax=Math.max(this.wavemax,this.accum);if(this.wavemax>0&&this.accum<10){this.accum-=(this.wavemax*.009);this.wavemax*=0.99;}
if(this.$w.scrollTop()>=this.$body.height()-window.innerHeight*1.5){window.scrollTo(0,0);}}}